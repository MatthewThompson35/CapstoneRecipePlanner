<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\matth\Desktop\capstone\CapstoneRecipePlanner\code\RecipePlannerApplication\RecipePlannerWebApplication\Controllers\HomeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Diagnostics;
using System.Text.RegularExpressions;
using Microsoft.AspNetCore.Mvc;
using RecipePlannerLibrary;
using RecipePlannerLibrary.Database;
using RecipePlannerLibrary.Models;
using RecipePlannerWebApplication.Models;

namespace RecipePlannerWebApplication.Controllers;

public class HomeController : Controller
{
    #region Data members

    private readonly ILogger&lt;HomeController&gt; _logger;

    #endregion

    #region Constructors

    public HomeController(ILogger&lt;HomeController&gt; logger)
    {
        this._logger = logger;
    }

    #endregion

    #region Methods

    /// &lt;summary&gt;
    ///     Takes the User to the login page
    /// &lt;/summary&gt;
    /// &lt;returns&gt;The Login Page&lt;/returns&gt;
    public IActionResult Index()
    {
        return View();
    }

    /// &lt;summary&gt;
    ///     Checks the login and goes to recipe page on successful login. Prompts for retry on failed login
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;ad&quot;&gt;The Login object containing user credentials&lt;/param&gt;
    /// &lt;returns&gt;
    ///     The Recipe Page view on successful login, Login Page view with error message on failed login or connection
    ///     error
    /// &lt;/returns&gt;
    [HttpPost]
    public IActionResult Index([Bind] Login ad)
    {
        try
        {
            var res = Database.LoginCheck(ad);
            if (res == 1)
            {
                ActiveUser.username = ad.Username;
                this.setupForRecipePage();
                return View(&quot;RecipePage&quot;);
            }

            ad.ErrorMessage = &quot;Incorrect username or password&quot;;
            return View(ad);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
            return View(&quot;Index&quot;);
        }
    }

    private void setupForRecipePage(int? page = 1)
    {
        try
        {
            List&lt;Recipe&gt; recipes = RecipeDAL.getRecipes(Connection.ConnectionString);

            foreach (var recipe in recipes)
            {
                recipe.Ingredients = RecipeDAL.getIngredientsForRecipe(recipe.RecipeId, Connection.ConnectionString);
                recipe.Steps = RecipeDAL.getStepsForRecipe(recipe.RecipeId, Connection.ConnectionString);
                recipe.Tags = RecipeDAL.getTagsForRecipe(recipe.RecipeId, Connection.ConnectionString);
            }

            this.addToAvailableRecipes(recipes);
            const int pageSize = 1;
            var currentPage = page ?? 1;

            ViewBag.currentPage = currentPage;
            ViewBag.AvailableRecipes.Sort((Comparison&lt;Recipe&gt;) this.CompareRecipesByName);
            ViewBag.AllRecipes.Sort((Comparison&lt;Recipe&gt;) this.CompareRecipesByName);
            int totalAvailableRecipes = ViewBag.AvailableRecipes.Count;
            var totalAvailablePages = (int) Math.Ceiling((double) totalAvailableRecipes / pageSize);
            ViewBag.totalAvailablePages = totalAvailablePages;
            ViewBag.totalPages = recipes.Count;
            List&lt;Recipe&gt; availableRecipes = ViewBag.AvailableRecipes;
            List&lt;Recipe&gt; allRecipes = ViewBag.AllRecipes;
            var currentAllPage = 1;

            var AvailableRecipesOnPage = availableRecipes
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            ViewBag.availableRecipesOnPage = AvailableRecipesOnPage;

            var AllRecipesOnPage = allRecipes
                .Skip((currentAllPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            ViewBag.AllRecipesOnPage = AllRecipesOnPage;
            ViewBag.CurrentSelectedRadio = &quot;available&quot;;
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }
    }

    /// &lt;summary&gt;
    ///     Adds to the available recipes if the user can make that recipe.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;recipes&quot;&gt;The recipes.&lt;/param&gt;
    private void addToAvailableRecipes(List&lt;Recipe&gt; recipes)
    {
        try
        {
            ViewBag.AvailableRecipes = new List&lt;Recipe&gt;();
            ViewBag.AllRecipes = recipes;
            foreach (var recipe in ViewBag.AllRecipes)
            {
                var add = true;
                recipe.Ingredients = RecipeDAL.getIngredientsForRecipe(recipe.RecipeId, Connection.ConnectionString);
                foreach (RecipeIngredient ingredient in recipe.Ingredients)
                {
                    var ing = IngredientDAL.getIngredients(ingredient.IngredientName);
                    if (ing != null &amp;&amp; ing.Count &gt; 0)
                    {
                        if (ing[0].quantity &lt; ingredient.Quantity)
                        {
                            add = false;
                        }
                    }
                    else
                    {
                        add = false;
                    }
                }

                if (add)
                {
                    ViewBag.AvailableRecipes.Add(recipe);
                }
            }
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }
    }

    /// &lt;summary&gt;
    ///     Compares the name of the recipes so that it can be sorted alphabetically.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;recipe1&quot;&gt;The recipe1.&lt;/param&gt;
    /// &lt;param name=&quot;recipe2&quot;&gt;The recipe2.&lt;/param&gt;
    /// &lt;returns&gt; 0 or 1 based on which recipe name comes first&lt;/returns&gt;
    private int CompareRecipesByName(Recipe recipe1, Recipe recipe2)
    {
        return recipe1.Name.CompareTo(recipe2.Name);
    }

    /// &lt;summary&gt;
    ///     Decrements the quantity of a given ingredient by its id.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;id&quot;&gt;The id of the ingredient to decrement quantity for.&lt;/param&gt;
    /// &lt;returns&gt;The view of the ingredients page.&lt;/returns&gt;
    public ActionResult decrementQuantity(string id)
    {
        try
        {
            ViewBag.ingredients = IngredientDAL.getIngredients();
            var quantity = 0;
            var ingredientID = int.Parse(id);

            quantity = this.getItemQuantity(ingredientID);
            IngredientDAL.decrementQuantity(ingredientID, quantity);
            this.setupIngredientsPage(ViewBag.currentPage);
            return View(&quot;IngredientsPage&quot;);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }

        return View(&quot;Index&quot;);
    }

    /// &lt;summary&gt;
    ///     Gets the quantity of the ingredient with the given id.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;id&quot;&gt;The ingredient id.&lt;/param&gt;
    /// &lt;returns&gt;The quantity of the ingredient&lt;/returns&gt;
    private int getItemQuantity(int id)
    {
        var quantity = 0;
        foreach (var item in ViewBag.ingredients)
        {
            if (item.id == id)
            {
                quantity = item.quantity;
            }
        }

        return quantity;
    }

    /// &lt;summary&gt;
    ///     Increments the quantity of the ingredient with the given id.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;id&quot;&gt;The ingredient id.&lt;/param&gt;
    /// &lt;returns&gt;The ingredients page or login on server connection error&lt;/returns&gt;
    public ActionResult incrementQuantity(string id)
    {
        try
        {
            ViewBag.ingredients = IngredientDAL.getIngredients();
            var quantity = 0;
            var ingredientID = int.Parse(id);

            quantity = this.getItemQuantity(ingredientID);
            IngredientDAL.incrementQuantity(ingredientID, quantity);
            this.setupIngredientsPage(ViewBag.currentPage);
            return View(&quot;IngredientsPage&quot;);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }

        return View(&quot;Index&quot;);
    }

    /// &lt;summary&gt;
    ///     Removes the ingredient from the list.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;id&quot;&gt;The identifier of the ingredient to be removed.&lt;/param&gt;
    /// &lt;returns&gt;The ingredients page or login on server connection error.&lt;/returns&gt;
    public ActionResult removeIngredient(string id)
    {
        try
        {
            IngredientDAL.RemoveIngredient(int.Parse(id));
            this.setupIngredientsPage(ViewBag.currentPage);
            return View(&quot;IngredientsPage&quot;);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }

        return View(&quot;Index&quot;);
    }

    /// &lt;summary&gt;
    ///     Adds the ingredient to the list.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;txtIngredientName&quot;&gt;The name of the ingredient.&lt;/param&gt;
    /// &lt;param name=&quot;txtQuantity&quot;&gt;The quantity of the ingredient.&lt;/param&gt;
    /// &lt;param name=&quot;measurement&quot;&gt;The measurement unit of the ingredient.&lt;/param&gt;
    /// &lt;returns&gt;The ingredients page or login on server connection error.&lt;/returns&gt;
    [HttpPost]
    public ActionResult AddIngredient(string txtIngredientName, string txtQuantity, string measurement)
    {
        var measurements = Enum.GetNames(typeof(Measurement)).ToList();
        ViewBag.Measurements = measurements;
        var regex = new Regex(&quot;^[0-9]+$&quot;);
        try
        {
            if (txtIngredientName == null || txtQuantity == null || txtIngredientName == &quot;&quot; || txtQuantity == &quot;&quot;)
            {
                ViewBag.Error = &quot;Please enter values.&quot;;
                return View(&quot;AddIngredient&quot;, ViewBag.Measurements);
            }

            if (IngredientDAL.getIngredients(txtIngredientName).Count() &gt; 0)
            {
                ViewBag.Error = &quot;Ingredient is already entered.&quot;;
                return View(&quot;AddIngredient&quot;, ViewBag.Measurements);
            }

            if (!regex.Match(txtQuantity).Success)
            {
                ViewBag.Error = &quot;Quantity must be an integer.&quot;;
                return View(&quot;AddIngredient&quot;, ViewBag.Measurements);
            }

            IngredientDAL.addIngredient(txtIngredientName, int.Parse(txtQuantity), measurement,
                Connection.ConnectionString);
            var totalPages = (int) Math.Ceiling((double) IngredientDAL.getIngredients().Count / 5);
            this.setupIngredientsPage(totalPages);
            return View(&quot;IngredientsPage&quot;);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }

        return View(&quot;Index&quot;);
    }

    /// &lt;summary&gt;
    ///     Goes to ingredients page with specified page number.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;page&quot;&gt;The page number to navigate to.&lt;/param&gt;
    /// &lt;returns&gt;Returns the ingredients page with the specified page of ingredients.&lt;/returns&gt;
    public ActionResult goToIngredientsPage(int? page)
    {
        try
        {
            this.setupIngredientsPage(page);
            return View(&quot;IngredientsPage&quot;);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
            return View(&quot;Index&quot;);
        }
    }

    private void setupIngredientsPage(int? page)
    {
        const int pageSize = 5; // Change this to the desired page size
        var currentPage = page ?? 1;
        List&lt;Ingredient&gt; allIngredients = IngredientDAL.getIngredients();
        var totalIngredients = allIngredients.Count;
        var totalPages = (int) Math.Ceiling((double) totalIngredients / pageSize);

        var ingredientsOnPage = allIngredients
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();

        ViewBag.currentPage = currentPage;
        ViewBag.totalPages = totalPages;
        ViewBag.ingredientsOnPage = ingredientsOnPage;
    }

    /// &lt;summary&gt;
    ///     Goes to RecipesPage that displays the available recipes by default with the specified page number
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;page&quot;&gt;The page number to navigate to.&lt;/param&gt;
    /// &lt;returns&gt;The recipes page with the specified page or login on server connection error&lt;/returns&gt;
    public ActionResult goToRecipePage(int? page)
    {
        try
        {
            this.setupForRecipePage(page);
            if (ViewBag.AvailableRecipes == null)
            {
                TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
                return View(&quot;Index&quot;);
            }

            return View(&quot;RecipePage&quot;, ViewBag.AvailableRecipes);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }

        return View(&quot;Index&quot;);
    }

    /// &lt;summary&gt;
    ///     Goes to RecipesPage that displays all recipes by default with the specified page number
    /// &lt;/summary&gt;
    /// &lt;returns&gt;The recipes page with the specified page or login on server connection error&lt;/returns&gt;
    public ActionResult goToRecipePageAll(int? page)
    {
        try
        {
            this.setupForRecipePageAll(page);
            if (ViewBag.AvailableRecipes == null)
            {
                TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
                return View(&quot;Index&quot;);
            }

            return View(&quot;RecipePage&quot;, ViewBag.AvailableRecipes);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }

        return View(&quot;Index&quot;);
    }

    private void setupForRecipePageAll(int? page)
    {
        try
        {
            List&lt;Recipe&gt; recipes = RecipeDAL.getRecipes(Connection.ConnectionString);
            foreach (var recipe in recipes)
            {
                recipe.Ingredients = RecipeDAL.getIngredientsForRecipe(recipe.RecipeId, Connection.ConnectionString);
                recipe.Steps = RecipeDAL.getStepsForRecipe(recipe.RecipeId, Connection.ConnectionString);
                recipe.Tags = RecipeDAL.getTagsForRecipe(recipe.RecipeId, Connection.ConnectionString);
            }

            var currentPage = 1;
            this.addToAvailableRecipes(recipes);
            const int pageSize = 1;
            var currentAllPage = page ?? 1;

            ViewBag.currentAllPage = currentAllPage;
            ViewBag.AvailableRecipes.Sort((Comparison&lt;Recipe&gt;) this.CompareRecipesByName);
            ViewBag.AllRecipes.Sort((Comparison&lt;Recipe&gt;) this.CompareRecipesByName);
            int totalAvailableRecipes = ViewBag.AvailableRecipes.Count;
            var totalAvailablePages = (int) Math.Ceiling((double) totalAvailableRecipes / pageSize);
            ViewBag.totalAvailablePages = totalAvailablePages;
            ViewBag.totalPages = (int) Math.Ceiling((double) recipes.Count / pageSize);
            List&lt;Recipe&gt; availableRecipes = ViewBag.AvailableRecipes;
            List&lt;Recipe&gt; allRecipes = ViewBag.AllRecipes;

            var AvailableRecipesOnPage = availableRecipes
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            ViewBag.availableRecipesOnPage = AvailableRecipesOnPage;

            var AllRecipesOnPage = allRecipes
                .Skip((currentAllPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            ViewBag.AllRecipesOnPage = AllRecipesOnPage;
            ViewBag.CurrentSelectedRadio = &quot;all&quot;;
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }
    }

    /// &lt;summary&gt;
    ///     Adds the planned meal to the database.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;recipeId&quot;&gt;The id for the recipe.&lt;/param&gt;
    /// &lt;param name=&quot;week&quot;&gt;The week of the meal.&lt;/param&gt;
    /// &lt;param name=&quot;day&quot;&gt;The day of the meal.&lt;/param&gt;
    /// &lt;param name=&quot;type&quot;&gt;The meal type&lt;/param&gt;
    /// &lt;returns&gt;The Recipe Page Defaulted to page one&lt;/returns&gt;
    public ActionResult addPlannedMeal(int recipeId, string week, string day, string type)
    {
        var recipeID = recipeId;
        var Week = week;
        var Day = day;
        var Type = type;
        DayOfWeek dayOfWeek;
        Enum.TryParse(day, out dayOfWeek);
        DateTime date;
        if (week.Equals(&quot;This Week&quot;))
        {
            date = Util.GetDateOfWeekDay(dayOfWeek, &quot;this&quot;);
        }
        else
        {
            date = Util.GetDateOfWeekDay(dayOfWeek, &quot;next&quot;);
        }

        if (PlannedMealDal.exists(Connection.ConnectionString, Type, date))
        {
            ViewBag.day = day;
            ViewBag.type = type;
            ViewBag.date = date;
            ViewBag.recipeId = recipeId;
            return View(&quot;OverwriteConformation&quot;);
        }

        PlannedMealDal.addPlannedMeal(Connection.ConnectionString, recipeId, day, type, date);
        this.setupForRecipePage();
        if (ViewBag.day == null)
        {
            ViewBag.day = &quot;Monday&quot;;
        }

        if (ViewBag.type == null)
        {
            ViewBag.type = &quot;Breakfast&quot;;
        }

        if (ViewBag.week == null)
        {
            ViewBag.week = &quot;This Week&quot;;
        }

        if (ViewBag.AvailableRecipes == null)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
            return View(&quot;Index&quot;);
        }

        return View(&quot;RecipePage&quot;, ViewBag.AvailableRecipes);
    }

    /// &lt;summary&gt;
    ///     Overwrites the recipe for the specified day and meal type.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;day&quot;&gt;The day of the week.&lt;/param&gt;
    /// &lt;param name=&quot;type&quot;&gt;The type of meal (e.g. breakfast, lunch, dinner).&lt;/param&gt;
    /// &lt;param name=&quot;date&quot;&gt;The date of the meal.&lt;/param&gt;
    /// &lt;param name=&quot;recipeId&quot;&gt;The ID of the recipe to use.&lt;/param&gt;
    /// &lt;returns&gt;The recipes page or login on server connection error.&lt;/returns&gt;
    public ActionResult overwriteAddedMeal(string day, string type, string date, int recipeId)
    {
        var Date = DateTime.Parse(date);
        PlannedMealDal.UpdateThisWeeksMeal(Connection.ConnectionString, day, type, Date, recipeId);
        return this.goToRecipePage(1);
    }

    /// &lt;summary&gt;
    ///     Updates the planned meal for a given recipe on a specific week day.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;recipeId&quot;&gt;The ID of the recipe to update.&lt;/param&gt;
    /// &lt;param name=&quot;week&quot;&gt;The week to update the planned meal for.&lt;/param&gt;
    /// &lt;param name=&quot;day&quot;&gt;The day of the week to update the planned meal for.&lt;/param&gt;
    /// &lt;param name=&quot;type&quot;&gt;The type of meal to update (e.g. breakfast, lunch, dinner).&lt;/param&gt;
    /// &lt;returns&gt;The updated recipes page or login on server connection error.&lt;/returns&gt;
    public ActionResult UpdateThisWeeksMeal(int recipeId, string week, string day, string type)
    {
        var recipeID = recipeId;
        var Week = week;
        var Day = day;
        var Type = type;
        DayOfWeek dayOfWeek;
        Enum.TryParse(day, out dayOfWeek);
        DateTime date;
        if (week.Equals(&quot;This Week&quot;))
        {
            date = Util.GetDateOfWeekDay(dayOfWeek, &quot;this&quot;);
        }
        else
        {
            date = Util.GetDateOfWeekDay(dayOfWeek, &quot;next&quot;);
        }

        PlannedMealDal.UpdateThisWeeksMeal(Connection.ConnectionString, Day, Type, date, recipeID);
        this.setupForRecipePage();
        if (ViewBag.AvailableRecipes == null)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
            return View(&quot;Index&quot;);
        }

        return View(&quot;RecipePage&quot;, ViewBag.AvailableRecipes);
    }


    /// &lt;summary&gt;
    ///     Goes to add ingredients page.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;The add ingredients page or login on server connection&lt;/returns&gt;
    public ActionResult goToAddIngredientsPage()
    {
        var measurements = Enum.GetNames(typeof(Measurement)).ToList();
        ViewBag.Measurements = measurements;
        return View(&quot;AddIngredient&quot;, ViewBag.Measurements);
    }

    /// &lt;summary&gt;
    ///     Toggles the week for Planned Meals page.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;currentWeek&quot;&gt;The current week.&lt;/param&gt;
    /// &lt;returns&gt;The planned meals page based on which week is given&lt;/returns&gt;
    public ActionResult ToggleWeek(string currentWeek)
    {
        if (currentWeek.Equals(&quot;Next Week&quot;))
        {
            this.goToPlannedMealsPage();
        }
        else
        {
            this.goToPlannedMealsPageNextWeek();
        }

        return View(&quot;PlannedMealsPage&quot;);
    }

    public JsonResult GetRecipeName(string day, string mealType, string week)
    {
        try
        {
            var ThisWeeksMeals = new Dictionary&lt;(string, string), int&gt;();
            if (week.Equals(&quot;Next Week&quot;))
            {
                ThisWeeksMeals = PlannedMealDal.getNextWeeksMeals(Connection.ConnectionString);
            }
            else
            {
                ThisWeeksMeals = PlannedMealDal.getThisWeeksMeals(Connection.ConnectionString);
            }

            var recipeId = ThisWeeksMeals[(day, mealType)];
            var allRecipes = RecipeDAL.getRecipes(Connection.ConnectionString);
            var recipeName = &quot;&quot;;
            foreach (var recipe in allRecipes)
            {
                if (recipe.RecipeId == recipeId)
                {
                    recipeName = recipe.Name;
                }
            }

            ViewBag.Header = &quot;This weeks meals&quot;;
            return Json(new {RecipeId = recipeId, RecipeName = recipeName});
        }
        catch (Exception ex)
        {
            var recipeId = &quot;You have not yet added a meal for this time&quot;;
            return Json(new {RecipeId = recipeId, RecipeName = &quot;You Have not yet added a meal for this time&quot;});
        }
    }

    public JsonResult RemoveThisWeeksMeal(string day, string mealType, string week)
    {
        try
        {
            var ThisWeeksMeals = new Dictionary&lt;(string, string), int&gt;();
            if (week.Equals(&quot;Next Week&quot;))
            {
                ThisWeeksMeals = PlannedMealDal.getNextWeeksMeals(Connection.ConnectionString);
            }
            else
            {
                ThisWeeksMeals = PlannedMealDal.getThisWeeksMeals(Connection.ConnectionString);
            }

            var recipeId = ThisWeeksMeals[(day, mealType)];
            DayOfWeek dayOfWeek;
            Enum.TryParse(day, out dayOfWeek);
            DateTime date;
            if (week.Equals(&quot;Next Week&quot;))
            {
                date = Util.GetDateOfWeekDay(dayOfWeek, &quot;next&quot;);
            }
            else
            {
                date = Util.GetDateOfWeekDay(dayOfWeek, &quot;this&quot;);
            }

            PlannedMealDal.RemoveThisWeekMeal(Connection.ConnectionString, recipeId, day, mealType, date);

            ViewBag.Header = &quot;This weeks meals&quot;;
            return Json(new {RecipeId = recipeId, RecipeName = &quot;You Have not yet added a meal for this time&quot;});
        }
        catch (Exception ex)
        {
            try
            {
                var ThisWeeksMeals = PlannedMealDal.getThisWeeksMeals(Connection.ConnectionString);
                var recipeId = ThisWeeksMeals[(day, mealType)];
                var allRecipes = RecipeDAL.getRecipes(Connection.ConnectionString);
                var recipeName = &quot;&quot;;
                foreach (var recipe in allRecipes)
                {
                    if (recipe.RecipeId == recipeId)
                    {
                        recipeName = recipe.Name;
                    }
                }

                return Json(new {RecipeName = recipeName});
            }
            catch (Exception ex2)
            {
                return Json(new {RecipeName = &quot;You Have not yet added a meal for this time&quot;});
            }
        }
    }

    /// &lt;summary&gt;
    ///     Goes to add ingredients page.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;The add ingredients page or login on server connection&lt;/returns&gt;
    public ActionResult goToPlannedMealsPage()
    {
        ViewBag.CurrentWeek = &quot;This Week&quot;;
        List&lt;Recipe&gt; recipes = RecipeDAL.getRecipes(Connection.ConnectionString);
        foreach (var recipe in recipes)
        {
            recipe.Ingredients = RecipeDAL.getIngredientsForRecipe(recipe.RecipeId, Connection.ConnectionString);
            recipe.Steps = RecipeDAL.getStepsForRecipe(recipe.RecipeId, Connection.ConnectionString);
            recipe.Tags = RecipeDAL.getTagsForRecipe(recipe.RecipeId, Connection.ConnectionString);
        }

        ViewBag.AllRecipes = recipes;
        var breakfast = new List&lt;string&gt;();
        var dictionary = PlannedMealDal.getThisWeeksMeals(Connection.ConnectionString);
        var daysOfWeek = new List&lt;string&gt;
            {&quot;Monday&quot;, &quot;Tuesday&quot;, &quot;Wednesday&quot;, &quot;Thursday&quot;, &quot;Friday&quot;, &quot;Saturday&quot;, &quot;Sunday&quot;};
        foreach (var day in daysOfWeek)
        {
            var json = this.GetRecipeName(day, &quot;Breakfast&quot;, &quot;This Week&quot;);
            var recipeName = (string) json.Value.GetType().GetProperty(&quot;RecipeName&quot;).GetValue(json.Value);
            breakfast.Add(recipeName);
        }

        ViewBag.DefaultValues = breakfast;
        ViewBag.Header = &quot;This weeks meals&quot;;
        ViewBag.CurrentWeek = &quot;This Week&quot;;
        return View(&quot;PlannedMealsPage&quot;);
    }

    /// &lt;summary&gt;
    ///     Goes to add ingredients page.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;The add ingredients page or login on server connection&lt;/returns&gt;
    public ActionResult goToPlannedMealsPageNextWeek()
    {
        ViewBag.CurrentWeek = &quot;Next Week&quot;;
        List&lt;Recipe&gt; recipes = RecipeDAL.getRecipes(Connection.ConnectionString);
        foreach (var recipe in recipes)
        {
            recipe.Ingredients = RecipeDAL.getIngredientsForRecipe(recipe.RecipeId, Connection.ConnectionString);
            recipe.Steps = RecipeDAL.getStepsForRecipe(recipe.RecipeId, Connection.ConnectionString);
            recipe.Tags = RecipeDAL.getTagsForRecipe(recipe.RecipeId, Connection.ConnectionString);
        }

        ViewBag.AllRecipes = recipes;
        var breakfast = new List&lt;string&gt;();
        var daysOfWeek = new List&lt;string&gt;
            {&quot;Monday&quot;, &quot;Tuesday&quot;, &quot;Wednesday&quot;, &quot;Thursday&quot;, &quot;Friday&quot;, &quot;Saturday&quot;, &quot;Sunday&quot;};
        foreach (var day in daysOfWeek)
        {
            var json = this.GetRecipeName(day, &quot;Breakfast&quot;, &quot;Next Week&quot;);
            var recipeName = (string) json.Value.GetType().GetProperty(&quot;RecipeName&quot;).GetValue(json.Value);
            breakfast.Add(recipeName);
        }

        ViewBag.DefaultValues = breakfast;
        ViewBag.Header = &quot;Next weeks meals&quot;;
        ViewBag.CurrentWeek = &quot;Next Week&quot;;
        return View(&quot;PlannedMealsPage&quot;);
    }

    /// &lt;summary&gt;
    ///     Creates the user.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
    /// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;
    /// &lt;param name=&quot;repeatPassword&quot;&gt;The repeat password.&lt;/param&gt;
    /// &lt;returns&gt;The login page or register is user was not added or login on server connection error&lt;/returns&gt;
    [HttpPost]
    public ActionResult CreateUser(string username, string password, string repeatPassword)
    {
        try
        {
            List&lt;string&gt; list = Database.ContainsUser(username);
            if (list.Count() &gt; 0)
            {
                ViewBag.Error = &quot;Username already exists. Please choose another and try again.&quot;;
                return View(&quot;Register&quot;);
            }

            if (password.Equals(repeatPassword))
            {
                Database.CreateUser(username, password);
                return View(&quot;Index&quot;);
            }

            ViewBag.Error = &quot;Passwords do not match. Please try again.&quot;;
            return View(&quot;Register&quot;);
        }
        catch (Exception ex)
        {
            TempData[&quot;msg&quot;] = &quot;The connection to the server could not be made&quot;;
        }

        return View(&quot;Register&quot;);
    }

    /// &lt;summary&gt;
    ///     Opens the register.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;The register page&lt;/returns&gt;
    [HttpPost]
    public ActionResult OpenRegister()
    {
        return View(&quot;Register&quot;);
    }

    /// &lt;summary&gt;
    ///     Errors this instance.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;The view&lt;/returns&gt;
    [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
    public IActionResult Error()
    {
        return View(new ErrorViewModel {RequestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier});
    }

    /// &lt;summary&gt;
    ///     Logs out this instance.
    /// &lt;/summary&gt;
    /// &lt;returns&gt; The login page&lt;/returns&gt;
    [HttpPost]
    public IActionResult Logout()
    {
        return View(&quot;Index&quot;);
    }

    #endregion
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,5,21,58,0],[22,5,22,6,0],[23,9,23,31,0],[24,5,24,6,0],[35,5,35,6,0],[36,9,36,23,0],[37,5,37,6,0],[49,5,49,6,0],[51,9,51,10,0],[52,13,52,47,0],[53,13,53,26,0],[54,13,54,14,0],[55,17,55,51,0],[56,17,56,43,0],[57,17,57,43,0],[60,13,60,64,0],[61,13,61,29,0],[63,9,63,29,0],[64,9,64,10,0],[65,13,65,80,0],[66,13,66,34,0],[68,5,68,6,0],[71,5,71,6,0],[73,9,73,10,0],[74,13,74,86,0],[76,13,76,20,0],[76,22,76,32,0],[76,33,76,35,0],[76,36,76,43,0],[77,13,77,14,0],[78,17,78,118,0],[79,17,79,106,0],[80,17,80,104,0],[81,13,81,14,0],[83,13,83,49,0],[85,13,85,41,0],[87,13,87,47,0],[88,13,88,91,0],[89,13,89,85,0],[90,13,90,72,0],[91,13,91,101,0],[92,13,92,63,0],[93,13,93,48,0],[94,13,94,70,0],[95,13,95,58,0],[96,13,96,36,0],[98,13,101,27,0],[103,13,103,69,0],[105,13,108,27,0],[110,13,110,57,0],[111,13,111,56,0],[112,9,112,10,0],[113,9,113,29,0],[114,9,114,10,0],[115,13,115,80,0],[116,9,116,10,0],[117,5,117,6,0],[124,5,124,6,0],[126,9,126,10,0],[127,13,127,59,0],[128,13,128,42,0],[129,13,129,20,0],[129,22,129,32,0],[129,33,129,35,0],[129,36,129,54,0],[130,13,130,14,0],[131,17,131,32,0],[132,17,132,118,0],[133,17,133,24,0],[133,26,133,53,0],[133,54,133,56,0],[133,57,133,75,0],[134,17,134,18,0],[135,21,135,87,0],[136,21,136,54,0],[137,21,137,22,0],[138,25,138,67,0],[139,25,139,26,0],[140,29,140,41,0],[141,25,141,26,0],[142,21,142,22,0],[144,21,144,22,0],[145,25,145,37,0],[146,21,146,22,0],[147,17,147,18,0],[149,17,149,25,0],[150,17,150,18,0],[151,21,151,58,0],[152,17,152,18,0],[153,13,153,14,0],[154,9,154,10,0],[155,9,155,29,0],[156,9,156,10,0],[157,13,157,80,0],[158,9,158,10,0],[159,5,159,6,0],[168,5,168,6,0],[169,9,169,53,0],[170,5,170,6,0],[178,5,178,6,0],[180,9,180,10,0],[181,13,181,66,0],[182,13,182,30,0],[183,13,183,46,0],[185,13,185,59,0],[186,13,186,69,0],[187,13,187,60,0],[188,13,188,44,0],[190,9,190,29,0],[191,9,191,10,0],[192,13,192,80,0],[193,9,193,10,0],[195,9,195,30,0],[196,5,196,6,0],[204,5,204,6,0],[205,9,205,26,0],[206,9,206,16,0],[206,18,206,26,0],[206,27,206,29,0],[206,30,206,49,0],[207,9,207,10,0],[208,13,208,31,0],[209,13,209,14,0],[210,17,210,42,0],[211,13,211,14,0],[212,9,212,10,0],[214,9,214,25,0],[215,5,215,6,0],[223,5,223,6,0],[225,9,225,10,0],[226,13,226,66,0],[227,13,227,30,0],[228,13,228,46,0],[230,13,230,59,0],[231,13,231,69,0],[232,13,232,60,0],[233,13,233,44,0],[235,9,235,29,0],[236,9,236,10,0],[237,13,237,80,0],[238,9,238,10,0],[240,9,240,30,0],[241,5,241,6,0],[249,5,249,6,0],[251,9,251,10,0],[252,13,252,59,0],[253,13,253,60,0],[254,13,254,44,0],[256,9,256,29,0],[257,9,257,10,0],[258,13,258,80,0],[259,9,259,10,0],[261,9,261,30,0],[262,5,262,6,0],[273,5,273,6,0],[274,9,274,72,0],[275,9,275,45,0],[276,9,276,43,0],[278,9,278,10,0],[279,13,279,114,0],[280,13,280,14,0],[281,17,281,56,0],[282,17,282,68,0],[285,13,285,77,0],[286,13,286,14,0],[287,17,287,66,0],[288,17,288,68,0],[291,13,291,51,0],[292,13,292,14,0],[293,17,293,64,0],[294,17,294,68,0],[297,13,298,46,0],[299,13,299,100,0],[300,13,300,51,0],[301,13,301,44,0],[303,9,303,29,0],[304,9,304,10,0],[305,13,305,80,0],[306,9,306,10,0],[308,9,308,30,0],[309,5,309,6,0],[317,5,317,6,0],[319,9,319,10,0],[320,13,320,45,0],[321,13,321,44,0],[323,9,323,29,0],[324,9,324,10,0],[325,13,325,80,0],[326,13,326,34,0],[328,5,328,6,0],[331,5,331,6,0],[333,9,333,37,0],[334,9,334,74,0],[335,9,335,53,0],[336,9,336,83,0],[338,9,341,23,0],[343,9,343,43,0],[344,9,344,41,0],[345,9,345,55,0],[346,5,346,6,0],[354,5,354,6,0],[356,9,356,10,0],[357,13,357,43,0],[358,13,358,50,0],[359,13,359,14,0],[360,17,360,84,0],[361,17,361,38,0],[364,13,364,65,0],[366,9,366,29,0],[367,9,367,10,0],[368,13,368,80,0],[369,9,369,10,0],[371,9,371,30,0],[372,5,372,6,0],[379,5,379,6,0],[381,9,381,10,0],[382,13,382,46,0],[383,13,383,50,0],[384,13,384,14,0],[385,17,385,84,0],[386,17,386,38,0],[389,13,389,65,0],[391,9,391,29,0],[392,9,392,10,0],[393,13,393,80,0],[394,9,394,10,0],[396,9,396,30,0],[397,5,397,6,0],[400,5,400,6,0],[402,9,402,10,0],[403,13,403,86,0],[404,13,404,20,0],[404,22,404,32,0],[404,33,404,35,0],[404,36,404,43,0],[405,13,405,14,0],[406,17,406,118,0],[407,17,407,106,0],[408,17,408,104,0],[409,13,409,14,0],[411,13,411,33,0],[412,13,412,49,0],[414,13,414,44,0],[416,13,416,53,0],[417,13,417,91,0],[418,13,418,85,0],[419,13,419,72,0],[420,13,420,101,0],[421,13,421,63,0],[422,13,422,88,0],[423,13,423,70,0],[424,13,424,58,0],[426,13,429,27,0],[431,13,431,69,0],[433,13,436,27,0],[438,13,438,57,0],[439,13,439,50,0],[440,9,440,10,0],[441,9,441,29,0],[442,9,442,10,0],[443,13,443,80,0],[444,9,444,10,0],[445,5,445,6,0],[456,5,456,6,0],[457,9,457,33,0],[458,9,458,25,0],[459,9,459,23,0],[460,9,460,25,0],[462,9,462,43,0],[464,9,464,38,0],[465,9,465,10,0],[466,13,466,61,0],[467,9,467,10,0],[469,9,469,10,0],[470,13,470,61,0],[471,9,471,10,0],[473,9,473,76,0],[474,9,474,10,0],[475,13,475,31,0],[476,13,476,33,0],[477,13,477,33,0],[478,13,478,41,0],[479,13,479,50,0],[482,9,482,95,0],[483,9,483,35,0],[484,9,484,33,0],[485,9,485,10,0],[486,13,486,36,0],[487,9,487,10,0],[489,9,489,34,0],[490,9,490,10,0],[491,13,491,40,0],[492,9,492,10,0],[494,9,494,34,0],[495,9,495,10,0],[496,13,496,40,0],[497,9,497,10,0],[499,9,499,46,0],[500,9,500,10,0],[501,13,501,80,0],[502,13,502,34,0],[505,9,505,61,0],[506,5,506,6,0],[517,5,517,6,0],[518,9,518,41,0],[519,9,519,100,0],[520,9,520,39,0],[521,5,521,6,0],[532,5,532,6,0],[533,9,533,33,0],[534,9,534,25,0],[535,9,535,23,0],[536,9,536,25,0],[538,9,538,43,0],[540,9,540,38,0],[541,9,541,10,0],[542,13,542,61,0],[543,9,543,10,0],[545,9,545,10,0],[546,13,546,61,0],[547,9,547,10,0],[549,9,549,100,0],[550,9,550,35,0],[551,9,551,46,0],[552,9,552,10,0],[553,13,553,80,0],[554,13,554,34,0],[557,9,557,61,0],[558,5,558,6,0],[566,5,566,6,0],[567,9,567,72,0],[568,9,568,45,0],[569,9,569,60,0],[570,5,570,6,0],[578,5,578,6,0],[579,9,579,45,0],[580,9,580,10,0],[581,13,581,41,0],[582,9,582,10,0],[584,9,584,10,0],[585,13,585,49,0],[586,9,586,10,0],[588,9,588,41,0],[589,5,589,6,0],[592,5,592,6,0],[594,9,594,10,0],[595,13,595,74,0],[596,13,596,42,0],[597,13,597,14,0],[598,17,598,96,0],[599,13,599,14,0],[601,13,601,14,0],[602,17,602,96,0],[603,13,603,14,0],[605,13,605,60,0],[606,13,606,80,0],[607,13,607,33,0],[608,13,608,20,0],[608,22,608,32,0],[608,33,608,35,0],[608,36,608,46,0],[609,13,609,14,0],[610,17,610,49,0],[611,17,611,18,0],[612,21,612,46,0],[613,17,613,18,0],[614,13,614,14,0],[616,13,616,49,0],[617,13,617,77,0],[619,9,619,29,0],[620,9,620,10,0],[621,13,621,74,0],[622,13,622,112,0],[624,5,624,6,0],[627,5,627,6,0],[629,9,629,10,0],[630,13,630,74,0],[631,13,631,42,0],[632,13,632,14,0],[633,17,633,96,0],[634,13,634,14,0],[636,13,636,14,0],[637,17,637,96,0],[638,13,638,14,0],[640,13,640,60,0],[642,13,642,47,0],[644,13,644,42,0],[645,13,645,14,0],[646,17,646,65,0],[647,13,647,14,0],[649,13,649,14,0],[650,17,650,65,0],[651,13,651,14,0],[653,13,653,107,0],[655,13,655,49,0],[656,13,656,112,0],[658,9,658,29,0],[659,9,659,10,0],[661,13,661,14,0],[662,17,662,100,0],[663,17,663,64,0],[664,17,664,84,0],[665,17,665,37,0],[666,17,666,24,0],[666,26,666,36,0],[666,37,666,39,0],[666,40,666,50,0],[667,17,667,18,0],[668,21,668,53,0],[669,21,669,22,0],[670,25,670,50,0],[671,21,671,22,0],[672,17,672,18,0],[674,17,674,60,0],[676,13,676,34,0],[677,13,677,14,0],[678,17,678,95,0],[681,5,681,6,0],[688,5,688,6,0],[689,9,689,43,0],[690,9,690,82,0],[691,9,691,16,0],[691,18,691,28,0],[691,29,691,31,0],[691,32,691,39,0],[692,9,692,10,0],[693,13,693,114,0],[694,13,694,102,0],[695,13,695,100,0],[696,9,696,10,0],[698,9,698,38,0],[699,9,699,44,0],[700,9,700,88,0],[701,9,702,92,0],[703,9,703,16,0],[703,18,703,25,0],[703,26,703,28,0],[703,29,703,39,0],[704,9,704,10,0],[705,13,705,74,0],[706,13,706,107,0],[707,13,707,39,0],[708,9,708,10,0],[710,9,710,43,0],[711,9,711,45,0],[712,9,712,43,0],[713,9,713,41,0],[714,5,714,6,0],[721,5,721,6,0],[722,9,722,43,0],[723,9,723,82,0],[724,9,724,16,0],[724,18,724,28,0],[724,29,724,31,0],[724,32,724,39,0],[725,9,725,10,0],[726,13,726,114,0],[727,13,727,102,0],[728,13,728,100,0],[729,9,729,10,0],[731,9,731,38,0],[732,9,732,44,0],[733,9,734,92,0],[735,9,735,16,0],[735,18,735,25,0],[735,26,735,28,0],[735,29,735,39,0],[736,9,736,10,0],[737,13,737,74,0],[738,13,738,107,0],[739,13,739,39,0],[740,9,740,10,0],[742,9,742,43,0],[743,9,743,45,0],[744,9,744,43,0],[745,9,745,41,0],[746,5,746,6,0],[757,5,757,6,0],[759,9,759,10,0],[760,13,760,65,0],[761,13,761,34,0],[762,13,762,14,0],[763,17,763,97,0],[764,17,764,41,0],[767,13,767,49,0],[768,13,768,14,0],[769,17,769,57,0],[770,17,770,38,0],[773,13,773,73,0],[774,13,774,37,0],[776,9,776,29,0],[777,9,777,10,0],[778,13,778,80,0],[779,9,779,10,0],[781,9,781,33,0],[782,5,782,6,0],[790,5,790,6,0],[791,9,791,33,0],[792,5,792,6,0],[800,5,800,6,0],[801,9,801,107,0],[802,5,802,6,0],[810,5,810,6,0],[811,9,811,30,0],[812,5,812,6,0]]);
    </script>
  </body>
</html>